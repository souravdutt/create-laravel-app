# Type Safety Guide

## Overview

This Laravel project is configured with hybrid type safety between PHP (backend) and TypeScript (frontend).

## Features

- ✅ **PHP DTOs → TypeScript Interfaces**: Automatic conversion
- ✅ **Runtime Validation**: Zod schemas for safe data exchange
- ✅ **Type-safe API Client**: Auto-generated fetch wrappers
- ✅ **Watch Mode**: Auto-regenerate on DTO changes

## Quick Start

### 1. Generate Types

After making changes to DTOs, regenerate types:

```bash
npm run gen:types
```

Or run individual commands:

```bash
php artisan typescript:transform
php artisan gen:zod-schemas
php artisan gen:ts-client
```

### 2. Watch Mode (Development)

Auto-regenerate types on DTO changes:

```bash
php artisan typescript:watch
```

### 3. Start Development Server

```bash
npm run dev
```

## Creating a New DTO

1. Create a new DTO in `app/DTO/`:

```php
<?php

namespace App\DTO;

use Spatie\TypeScriptTransformer\Attributes\TypeScript;

#[TypeScript]
class ProductDto
{
    public function __construct(
        public int $id,
        public string $name,
        public float $price,
        public ?string $description = null,
    ) {}
}
```

2. Use it in your controller:

```php
use App\DTO\ProductDto;

public function index(): JsonResponse
{
    $products = Product::all()->map(fn($p) => new ProductDto(
        id: $p->id,
        name: $p->name,
        price: $p->price,
        description: $p->description,
    ));

    return response()->json($products);
}
```

3. Regenerate types:

```bash
npm run gen:types
```

4. Use in TypeScript:

```typescript
import { api } from '@/api/client';

const products = await api.getProducts();
// products is fully typed and runtime validated!
```

## Using the API Client

The generated API client is type-safe and includes runtime validation:

```typescript
import { api } from '@/api/client';

// GET request
const users = await api.getUsers();
// Type: UserDto[]

// GET by ID
const user = await api.getUsersById('1');
// Type: UserDto

// POST request
const newUser = await api.postUsers({
  name: 'John Doe',
  email: 'john@example.com',
});
```

## Type Safety Flow

```
┌─────────────────┐
│  PHP DTO        │
│  UserDto.php    │
└────────┬────────┘
         │
         ├─────────────────────────┐
         │                         │
         ▼                         ▼
┌─────────────────┐      ┌──────────────────┐
│  TypeScript     │      │  Zod Schema      │
│  Interface      │      │  Runtime Valid.  │
│  UserDto.d.ts   │      │  UserDto.ts      │
└────────┬────────┘      └────────┬─────────┘
         │                         │
         └──────────┬──────────────┘
                    │
                    ▼
         ┌──────────────────┐
         │  API Client      │
         │  Typed & Safe    │
         │  client.ts       │
         └──────────────────┘
```

## Directory Structure

```
app/
├── DTO/
│   └── UserDto.php          ← Source of truth
├── Console/Commands/
│   ├── GenerateTypescriptClient.php
│   ├── GenerateZodSchemas.php
│   └── TypeScriptWatch.php
└── Http/Controllers/
    └── UserController.php

resources/js/
├── types/
│   ├── UserDto.ts           ← Auto-generated Zod + Interface
│   ├── generated.d.ts       ← Auto-generated by Spatie
│   └── index.ts
└── api/
    └── client.ts            ← Auto-generated API client
```

## Best Practices

1. **Never edit generated files manually** - They will be overwritten
2. **Always use DTOs for API responses** - Ensures type consistency
3. **Document return types in controllers** - Helps code generation
4. **Run type check before commit** - `npm run type-check`

## Commands Reference

| Command | Description |
|---------|-------------|
| `php artisan typescript:transform` | Generate TypeScript interfaces from DTOs |
| `php artisan gen:zod-schemas` | Generate Zod schemas for runtime validation |
| `php artisan gen:ts-client` | Generate typed API client from routes |
| `php artisan typescript:watch` | Watch mode - auto-regenerate on changes |
| `npm run gen:types` | Run all generation commands |
| `npm run type-check` | TypeScript type checking without emit |
| `npm run dev` | Start Vite dev server |

## Troubleshooting

### Types not updating

1. Delete generated files:
   ```bash
   rm resources/js/types/*.ts
   rm resources/js/api/client.ts
   ```

2. Regenerate:
   ```bash
   npm run gen:types
   ```

### TypeScript errors

1. Run type check:
   ```bash
   npm run type-check
   ```

2. Check that DTOs are properly annotated with `#[TypeScript]`

3. Ensure controller methods have proper return type hints

## Further Reading

- [Spatie TypeScript Transformer](https://github.com/spatie/laravel-typescript-transformer)
- [Zod Documentation](https://zod.dev)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/handbook/intro.html)
